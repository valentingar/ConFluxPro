<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Flux calculation • ConFluxPro</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Flux calculation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ConFluxPro</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/ConFluxPro.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/data_preparation.html">Data preparation</a></li>
    <li><a class="dropdown-item" href="../articles/flux.html">Flux calculation</a></li>
    <li><a class="dropdown-item" href="../articles/calibration.html">Calibration</a></li>
    <li><a class="dropdown-item" href="../articles/uncertainty.html">Uncertainty estimation</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/valentingar/confluxpro/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Flux calculation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/valentingar/confluxpro/blob/main/vignettes/flux.Rmd" class="external-link"><code>vignettes/flux.Rmd</code></a></small>
      <div class="d-none name"><code>flux.Rmd</code></div>
    </div>

    
    
<p>This vignette shows how to model flux rates with two functions
<code><a href="../reference/fg_flux.html">fg_flux()</a></code> and <code><a href="../reference/pro_flux.html">pro_flux()</a></code>. It builds on the
article on
<code><a href="../articles/data_preparation.html">vignette("data_preparation", package = "ConFluxPro")</a></code>, so
you are encouraged to first read that one.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://confluxpro.valentingartiser.de/" class="external-link">ConFluxPro</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'ConFluxPro'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter</span></span></code></pre></div>
<div class="section level2">
<h2 id="general-workflow">General workflow<a class="anchor" aria-label="anchor" href="#general-workflow"></a>
</h2>
<p>We will start by importing the <code><a href="../reference/cfp_dat.html">cfp_dat()</a></code> object, that we
created at the end of the last article
<code><a href="../articles/data_preparation.html">vignette("data_preparation", package = "ConFluxPro")</a></code>. This
is included in ConFluxPro as the dataset <code>base_dat</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"base_dat"</span>, package <span class="op">=</span> <span class="st">"ConFluxPro"</span><span class="op">)</span></span></code></pre></div>
<p>Note, that one of the most important settings of both models is
already made at this point: the definition of the flux layers in the
<code>layers_map</code> of the data. You need to carefully decide how
many layers and which boundaries to set. This may depend on your
research question and on your input data. You can always try out
different <code>layers_map</code> by changing them in the creation of
your <code><a href="../reference/cfp_dat.html">cfp_dat()</a></code> object.</p>
<p>Modeling flux rates with both functions is as easy as passing
<code>base_dat</code> as the single argument:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_pf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pro_flux.html">pro_flux</a></span><span class="op">(</span><span class="va">base_dat</span><span class="op">)</span></span>
<span><span class="va">mod_fg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fg_flux.html">fg_flux</a></span><span class="op">(</span><span class="va">base_dat</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; validating datasets</span></span>
<span><span class="co">#&gt; id_cols: site, Date, gas</span></span>
<span><span class="co">#&gt; 24 unique profiles</span></span></code></pre></div>
<p>This will use the default settings for both functions. We will look
into the fine-tuning of both in more detail later. For now we are only
interested in the objects returned. <code><a href="../reference/pro_flux.html">pro_flux()</a></code> returns an
object of class <code>cfp_pfres</code>, while <code><a href="../reference/fg_flux.html">fg_flux()</a></code>
returns a <code>cfp_fgres</code> object. Both have the same structure.
At their core is the input dataset <code>base_dat</code> with the model
settings as additional attributes. The model result is stored as another
<code>data.frame</code> in the list.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mod_pf</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "profiles"   "gasdata"    "soilphys"   "layers_map" "PROFLUX"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mod_fg</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "profiles"   "gasdata"    "soilphys"   "layers_map" "FLUX"</span></span></code></pre></div>
<p>These <code>data.frame</code>s hold the flux rates in the different
layers, and the optimized production rates of the inverse model
(<code><a href="../reference/pro_flux.html">pro_flux()</a></code>). To derive efflux rates, we don’t have to
interact with these internal datasets directly. Instead, we can simply
call <code><a href="../reference/efflux.html">efflux()</a></code> on the entire model result. This will return
a <code>data.frame</code> with the efflux rates (in µmol m<sup>-2</sup>
s<sup>-1</sup>) of each profile of the model.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">efflux_pf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/efflux.html">efflux</a></span><span class="op">(</span><span class="va">mod_pf</span><span class="op">)</span></span>
<span><span class="va">efflux_fg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/efflux.html">efflux</a></span><span class="op">(</span><span class="va">mod_fg</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">efflux_pf</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_profile object </span></span>
<span><span class="co">#&gt; id_cols: site Date gas </span></span>
<span><span class="co">#&gt; 6  unique profiles </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     site       Date gas    efflux prof_id</span></span>
<span><span class="co">#&gt; 1 site_a 2021-01-01 CO2 0.8347288       1</span></span>
<span><span class="co">#&gt; 2 site_b 2021-01-01 CO2 0.6741332       2</span></span>
<span><span class="co">#&gt; 3 site_a 2021-02-01 CO2 1.3672901       3</span></span>
<span><span class="co">#&gt; 4 site_b 2021-02-01 CO2 1.0613224       4</span></span>
<span><span class="co">#&gt; 5 site_a 2021-03-01 CO2 1.7443084       5</span></span>
<span><span class="co">#&gt; 6 site_b 2021-03-01 CO2 1.3906597       6</span></span></code></pre></div>
<p>Similarly, we can extract the total production rates for each layer
within the soil.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">production_pf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/production.html">production</a></span><span class="op">(</span><span class="va">mod_pf</span><span class="op">)</span></span>
<span><span class="va">production_fg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/production.html">production</a></span><span class="op">(</span><span class="va">mod_fg</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">production_pf</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_layered_profile object </span></span>
<span><span class="co">#&gt; id_cols: site Date gas </span></span>
<span><span class="co">#&gt; 3  unique profiles </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     site       Date gas upper lower layer   prod_abs   prod_rel    efflux F0</span></span>
<span><span class="co">#&gt; 1 site_a 2021-01-01 CO2     0  -100     1 0.09704722 0.11626198 0.8347288  0</span></span>
<span><span class="co">#&gt; 2 site_a 2021-01-01 CO2     5     0     2 0.73768158 0.88373802 0.8347288  0</span></span>
<span><span class="co">#&gt; 3 site_b 2021-01-01 CO2     0  -100     1 0.05406110 0.08019349 0.6741332  0</span></span>
<span><span class="co">#&gt; 4 site_b 2021-01-01 CO2     7     0     2 0.62007213 0.91980651 0.6741332  0</span></span>
<span><span class="co">#&gt; 5 site_a 2021-02-01 CO2     0  -100     1 0.14909176 0.10904179 1.3672901  0</span></span>
<span><span class="co">#&gt; 6 site_a 2021-02-01 CO2     5     0     2 1.21819835 0.89095821 1.3672901  0</span></span>
<span><span class="co">#&gt;   DELTA_F0 DELTA_prod_abs DELTA_prod_rel</span></span>
<span><span class="co">#&gt; 1       NA             NA             NA</span></span>
<span><span class="co">#&gt; 2       NA             NA             NA</span></span>
<span><span class="co">#&gt; 3       NA             NA             NA</span></span>
<span><span class="co">#&gt; 4       NA             NA             NA</span></span>
<span><span class="co">#&gt; 5       NA             NA             NA</span></span>
<span><span class="co">#&gt; 6       NA             NA             NA</span></span></code></pre></div>
<p>Here, <code>prod_abs</code> is the total production rate in the layer
(in in µmol m<sup>-2</sup> s<sup>-1</sup>), whereas
<code>prod_rel</code> is the relative contribution of that layer to the
total efflux.</p>
<p>Now that we’ve discussed the syntax, let’s discuss the specific
considerations and settings of each method.</p>
</div>
<div class="section level2">
<h2 id="fg_flux-the-classic-fgm">
<code>fg_flux()</code>: the ‘classic’ FGM<a class="anchor" aria-label="anchor" href="#fg_flux-the-classic-fgm"></a>
</h2>
<div class="section level3">
<h3 id="model-settings">Model settings<a class="anchor" aria-label="anchor" href="#model-settings"></a>
</h3>
<p>The function <code><a href="../reference/fg_flux.html">fg_flux()</a></code> implements different versions of
the ‘classic’ FGM. With this we mean a typical ‘forward’ calculation of
the concentration gradient and diffusion coefficient, in contrast to the
inverse model discussed below. In truth, <code><a href="../reference/fg_flux.html">fg_flux()</a></code> is a
collection of models, because there exist different philosophies on how
to calculate the concentration gradient and how to extrapolate the flux
rates to the surface. The default mode <code>"LL"</code> is to fit a
local linear model of <code>x_ppm~depth</code> within each layer
independently. Other modes fit a single model to the complete
concentration profile, either a linear spline (<code>"LS"</code>), or an
exponential model (<code>"EF"</code> and <code>"DA"</code>). We can use
one or more of these methods by using the <code>modes</code> argument.
If we choose multiple modes, we must also specify the <code>gases</code>
argument. This allows to choose a different mode for each gas that is
most applicable.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_fg_ef</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fg_flux.html">fg_flux</a></span><span class="op">(</span><span class="va">base_dat</span>, modes <span class="op">=</span> <span class="st">"EF"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; validating datasets</span></span>
<span><span class="co">#&gt; id_cols: site, Date, gas</span></span>
<span><span class="co">#&gt; 24 unique profiles</span></span>
<span><span class="va">mod_fg_multiple_modes</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fg_flux.html">fg_flux</a></span><span class="op">(</span><span class="va">base_dat</span>, </span>
<span>                                 modes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"LL"</span>, <span class="st">"LS"</span>, <span class="st">"EF"</span><span class="op">)</span>,</span>
<span>                                 gases <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"CO2"</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; validating datasets</span></span>
<span><span class="co">#&gt; id_cols: site, Date, gas</span></span>
<span><span class="co">#&gt; 24 unique profiles</span></span></code></pre></div>
<p>In addition, we also have to specify how parameters within the
<code>soilphys</code> dataset are aggregated. If the layers specified in
<code>layers_map</code> contain multiple layers in
<code>soilphys</code>, the parameters have to be averaged. Relevant for
the flux calculation are only the parameters <code>c_air</code>, the
number density of the soil air and <code>DS</code>, the apparent
diffusion coefficient. By default, <code>DS</code> is averaged as a
weighted harmonic mean, while <code>c_air</code> is averaged as a
weighted arithmetic mean. The weights in both cases are the respective
layer heights. You can change this, or add more parameters that are
averaged by setting the arguments <code>param</code> and
<code>funs</code>. These are vectors that must match in length. Each
<code>param</code> must be present as a column in
<code>soilphys</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_fg_more_params</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="../reference/fg_flux.html">fg_flux</a></span><span class="op">(</span><span class="va">base_dat</span>, </span>
<span>          modes <span class="op">=</span> <span class="st">"LL"</span>,</span>
<span>          gases <span class="op">=</span> <span class="st">"CO2"</span>,</span>
<span>          param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"c_air"</span>, <span class="st">"DS"</span>, <span class="st">"SWC"</span>, <span class="st">"t"</span><span class="op">)</span>,</span>
<span>          funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"arith"</span>, <span class="st">"harm"</span>, <span class="st">"arith"</span>, <span class="st">"harm"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; validating datasets</span></span>
<span><span class="co">#&gt; id_cols: site, Date, gas</span></span>
<span><span class="co">#&gt; 24 unique profiles</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="extrapolating-efflux">Extrapolating efflux<a class="anchor" aria-label="anchor" href="#extrapolating-efflux"></a>
</h3>
<p>How to derive efflux rates from the flux rates of each soil layer
requires some consideration. Here, we implement three different methods
that can be set in the call of <code><a href="../reference/efflux.html">efflux()</a></code>. The simplest is
simply to assume that the flux rate in the top layer is equivalent to
the efflux:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">efflux_fg_top</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/efflux.html">efflux</a></span><span class="op">(</span><span class="va">mod_fg</span>, method <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span></span></code></pre></div>
<p>The other two methods extrapolate to the surface. Both assume that
the modeled flux rate is centered in the layer, so that the flux of a
layer between 0 and 10 cm depth is located at 5 cm depth. The
<code>"lm"</code> model fits a linear model <code>flux~depth</code> of
all layers and extrapolates it to the surface. The <code>"lex"</code>
model uses two layers to linearly extrapolate the flux rate. These have
to be selected using the <code>layers</code> argument. Here we set
<code>layers = c(1, 2)</code> to select the top two layers for the
extrapolation. Since we only have two layers to begin with, the results
of <code>"lm"</code> and <code>"lex"</code> are the same in our
case.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">efflux_fg_lm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/efflux.html">efflux</a></span><span class="op">(</span><span class="va">mod_fg</span>, method <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span></span>
<span><span class="va">efflux_mod_lex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/efflux.html">efflux</a></span><span class="op">(</span><span class="va">mod_fg</span>, method <span class="op">=</span> <span class="st">"lex"</span>, layers <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="deriving-production-rates">Deriving production rates<a class="anchor" aria-label="anchor" href="#deriving-production-rates"></a>
</h3>
<p>The user input needed to derive production rates from a model
returned by <code><a href="../reference/fg_flux.html">fg_flux()</a></code> is simple. Because the efflux rate is
needed, we potentially have to specify how we want to calculate the
efflux rate. For this simply pass the same arguments as with
<code><a href="../reference/efflux.html">efflux()</a></code>. If nothing is specified, the default efflux
method is used (<code>"lm"</code>).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">production_fg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/production.html">production</a></span><span class="op">(</span><span class="va">mod_fg</span><span class="op">)</span></span></code></pre></div>
<p>The production rates of each layer are calculated as the difference
of the flux in the layer below and the flux in the layer above it. For
the lowest layer, the flux below is assumed to be zero, for the highest
layer the efflux is used as the upper flux. This process is prone to
artefacts stemming from the methods used in the calculation of the
concentration gradient. Production rates derived from
<code><a href="../reference/fg_flux.html">fg_flux()</a></code> should therefore be carefully checked for
plausibility.</p>
</div>
</div>
<div class="section level2">
<h2 id="pro_flux-inverse-model-of-production-profiles">
<code>pro_flux()</code>: inverse model of production profiles<a class="anchor" aria-label="anchor" href="#pro_flux-inverse-model-of-production-profiles"></a>
</h2>
<div class="section level3">
<h3 id="theory-and-implementation">Theory and implementation<a class="anchor" aria-label="anchor" href="#theory-and-implementation"></a>
</h3>
<p>The function <code><a href="../reference/pro_flux.html">pro_flux()</a></code> implements an inverse model of
soil gas production profiles. For each layer in <code>soilphys</code>, a
theoretical concentration profile is modeled. In this way, the complete
concentration profile can be modeled.
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>−</mo><mfrac><mi>P</mi><mrow><mn>2</mn><msub><mi>D</mi><mi>S</mi></msub></mrow></mfrac><mo>⋅</mo><msup><mi>z</mi><mn>2</mn></msup><mo>−</mo><mfrac><msub><mi>F</mi><mn>0</mn></msub><msub><mi>D</mi><mi>S</mi></msub></mfrac><mo>⋅</mo><mi>z</mi><mo>+</mo><msub><mi>c</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">
c(z) = - \frac{P}{2D_S} \cdot z^2 - \frac{F_0}{D_S} \cdot z + c_0
</annotation></semantics></math> The model is evaluated at each layer
boundary and “from-bottom-to-top”, meaning that the lowest layer is
modeled first. For each layer in <code>layers_map</code>, a production
rate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>P</mi><annotation encoding="application/x-tex">P</annotation></semantics></math>
(µmol m<sup>-3</sup> s<sup>-1</sup>) is algorithmically optimized to
achieve the best fit with the measured concentration profile. This is
achieved with the <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">stats::optim()</a></code> function and a custom
objective function. At the lowest layer, two boundary conditions need to
be met: the concentration
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>c</mi><mn>0</mn></msub><annotation encoding="application/x-tex">c_0</annotation></semantics></math>
and the incoming flux
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mn>0</mn></msub><annotation encoding="application/x-tex">F_0</annotation></semantics></math>
from the deep soil. While
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>c</mi><mn>0</mn></msub><annotation encoding="application/x-tex">c_0</annotation></semantics></math>
is set to the median of the measured value at that depth,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mn>0</mn></msub><annotation encoding="application/x-tex">F_0</annotation></semantics></math>
can be either set to zero, or optimized together with the production
rates
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>P</mi><annotation encoding="application/x-tex">P</annotation></semantics></math>.
In this model, the efflux is the sum of the production (or consumption)
in the entire profile. ## Model settings As with the ‘forward’ model,
the most important setting is to determine for which layers a production
rate is calculated, which is defined in <code>layers_map</code>. In
addition, there are now more settings that can be applied within the
call to <code><a href="../reference/cfp_layers_map.html">cfp_layers_map()</a></code>. Namely, we can set a upper
<code>highlim</code> and lower limit <code>lowlim</code> of the allowed
production rate within each layer. Be limiting the range in which the
production rates are optimized to positive values, we can exclude
consumption of the gas within the model. This can be relevant especially
for CO<sub>2</sub>, where negative concentration gradients are often the
result of measurement uncertainty and not of significant consumption of
the gas. For other gases, such as CH<sub>4</sub> both consumption and
production may be relevant processes that can also occur at different
points within the same profile.</p>
<p>The other important setting is <code>zero_flux</code> within the call
to <code><a href="../reference/pro_flux.html">pro_flux()</a></code>. If <code>TRUE</code> (the default), the flux
from below the model boundary into the lowest layer
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mn>0</mn></msub><annotation encoding="application/x-tex">F_0</annotation></semantics></math>)
is assumed to be zero. If <code>FALSE</code>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mn>0</mn></msub><annotation encoding="application/x-tex">F_0</annotation></semantics></math>
is optimized alongside the production rates within the soil. Typically,
there is no advantage in the modelling of setting <code>zero_flux</code>
to <code>FALSE</code>, even if the assumption that the flux is
negligible is not met. But be aware, that in this way, more production
may be allocated into the lowest layer than that layer actually
produced. If you do decide to use <code>zero_flux = FALSE</code>, you
can also set <code>zero_limits</code> that sets limits for the allowed
flux rates, analogous to <code>lowlim</code> and <code>highlim</code> in
<code><a href="../reference/cfp_layers_map.html">cfp_layers_map()</a></code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_pf_with_flux</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/pro_flux.html">pro_flux</a></span><span class="op">(</span><span class="va">base_dat</span>, </span>
<span>                             zero_flux <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                             zero_limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1000</span>, <span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>You can access the optimized
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mn>0</mn></msub><annotation encoding="application/x-tex">F_0</annotation></semantics></math>-flux
rates within the function <code><a href="../reference/deepflux.html">deepflux()</a></code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/deepflux.html">deepflux</a></span><span class="op">(</span><span class="va">mod_pf_with_flux</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_layered_profile object </span></span>
<span><span class="co">#&gt; id_cols: prof_id </span></span>
<span><span class="co">#&gt; 6  unique profiles </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   prof_id          F0   site       Date gas</span></span>
<span><span class="co">#&gt; 1       1 -0.07885403 site_a 2021-01-01 CO2</span></span>
<span><span class="co">#&gt; 2       3 -0.06299376 site_a 2021-02-01 CO2</span></span>
<span><span class="co">#&gt; 3       5 -0.10938257 site_a 2021-03-01 CO2</span></span>
<span><span class="co">#&gt; 4       7 -0.24329809 site_a 2021-04-01 CO2</span></span>
<span><span class="co">#&gt; 5       9 -0.32774961 site_a 2021-05-01 CO2</span></span>
<span><span class="co">#&gt; 6      11 -0.76478397 site_a 2021-06-01 CO2</span></span></code></pre></div>
<p>Other settings are more experimental, like <code>layer_couple</code>
within <code><a href="../reference/cfp_layers_map.html">cfp_layers_map()</a></code> which aims to penalize stark
changes of production within a profile, similar to
<code>evenness_factor</code> in <code><a href="../reference/pro_flux.html">pro_flux()</a></code>. We do not
encourage the use of these setting, as contrasting production rates may
be a sign that you defined too many production layers.</p>
</div>
<div class="section level3">
<h3 id="extracting-efflux-and-production-rates">Extracting efflux and production rates<a class="anchor" aria-label="anchor" href="#extracting-efflux-and-production-rates"></a>
</h3>
<p>Getting the efflux from any <code><a href="../reference/pro_flux.html">pro_flux()</a></code> model is very
simple by calling <code><a href="../reference/efflux.html">efflux()</a></code> on any model result. No
additional settings are necessary.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">EFFLUX_pf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/efflux.html">efflux</a></span><span class="op">(</span><span class="va">mod_pf</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">EFFLUX_pf</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_profile object </span></span>
<span><span class="co">#&gt; id_cols: site Date gas </span></span>
<span><span class="co">#&gt; 6  unique profiles </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     site       Date gas    efflux prof_id</span></span>
<span><span class="co">#&gt; 1 site_a 2021-01-01 CO2 0.8347288       1</span></span>
<span><span class="co">#&gt; 2 site_b 2021-01-01 CO2 0.6741332       2</span></span>
<span><span class="co">#&gt; 3 site_a 2021-02-01 CO2 1.3672901       3</span></span>
<span><span class="co">#&gt; 4 site_b 2021-02-01 CO2 1.0613224       4</span></span>
<span><span class="co">#&gt; 5 site_a 2021-03-01 CO2 1.7443084       5</span></span>
<span><span class="co">#&gt; 6 site_b 2021-03-01 CO2 1.3906597       6</span></span></code></pre></div>
<p>Similarly, you can call <code><a href="../reference/production.html">production()</a></code> to get the
optimized production rates for each layer in
<code>layers_map</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PRODUCTION_pf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/production.html">production</a></span><span class="op">(</span><span class="va">mod_pf</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">PRODUCTION_pf</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_layered_profile object </span></span>
<span><span class="co">#&gt; id_cols: site Date gas </span></span>
<span><span class="co">#&gt; 3  unique profiles </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     site       Date gas upper lower layer   prod_abs   prod_rel    efflux F0</span></span>
<span><span class="co">#&gt; 1 site_a 2021-01-01 CO2     0  -100     1 0.09704722 0.11626198 0.8347288  0</span></span>
<span><span class="co">#&gt; 2 site_a 2021-01-01 CO2     5     0     2 0.73768158 0.88373802 0.8347288  0</span></span>
<span><span class="co">#&gt; 3 site_b 2021-01-01 CO2     0  -100     1 0.05406110 0.08019349 0.6741332  0</span></span>
<span><span class="co">#&gt; 4 site_b 2021-01-01 CO2     7     0     2 0.62007213 0.91980651 0.6741332  0</span></span>
<span><span class="co">#&gt; 5 site_a 2021-02-01 CO2     0  -100     1 0.14909176 0.10904179 1.3672901  0</span></span>
<span><span class="co">#&gt; 6 site_a 2021-02-01 CO2     5     0     2 1.21819835 0.89095821 1.3672901  0</span></span>
<span><span class="co">#&gt;   DELTA_F0 DELTA_prod_abs DELTA_prod_rel</span></span>
<span><span class="co">#&gt; 1       NA             NA             NA</span></span>
<span><span class="co">#&gt; 2       NA             NA             NA</span></span>
<span><span class="co">#&gt; 3       NA             NA             NA</span></span>
<span><span class="co">#&gt; 4       NA             NA             NA</span></span>
<span><span class="co">#&gt; 5       NA             NA             NA</span></span>
<span><span class="co">#&gt; 6       NA             NA             NA</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Valentin Gartiser.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
