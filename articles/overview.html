<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>overview • ConFluxPro</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="overview">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ConFluxPro</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/overview.html">overview</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<link href="overview_files/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="overview_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><script src="overview_files/viz-1.8.2/viz.js"></script><link href="overview_files/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="overview_files/grViz-binding-1.0.11/grViz.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>overview</h1>
                        <h4 data-toc-skip class="author">Valentin
Gartiser</h4>
            
            <h4 data-toc-skip class="date">2022-04-29</h4>
      

      <div class="d-none name"><code>overview.Rmd</code></div>
    </div>

    
    
<style>
    img {
        border: 0;
    }
</style>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Hello and welcome to ConFluxPro - a toolkit for soil gas
analysis.</p>
<p>This package implements the <strong>Flux-Gradient Method
(FGM)</strong> for the calculation of gas fluxes from concentration
profiles. It provides a range of functions that cover the complete
process from raw data to modeling fluxes and beyond. A framework of S3
classes and methods aim to make the process as straightforward as
possible while keeping the control of the specific model in the hands of
the user.</p>
<p>This vignette provides an overview over the package structure,
including the most important functions and workflows. Further vignettes
will introduce the different models, functions and processes in more
detail.</p>
</div>
<div class="section level2">
<h2 id="package-structure">Package structure<a class="anchor" aria-label="anchor" href="#package-structure"></a>
</h2>
<p>The following graph gives an overview over the most important
functions within ConFluxPro. There are two main data objects that are
required for ConFluxPro models <strong>gasdata</strong> and
<strong>soilphys</strong>. The former contains information on <em>gas
concentration</em> profiles, the latter corresponding information on
soil physical parameters and, most importantly, <em>diffusivity</em>.
The model structure is defined in <strong>layers_map</strong>, where
<em>layers</em> are defined for which different parameters are set. All
data comes together in a single object with <strong>cfp_dat()</strong>.
Here, the different data sources are checked and prepared for
modelling.</p>
<p>Models include a traditional FGM approach in
<strong>fg_flux()</strong>, as well as an inverse approach in
<strong>pro_flux()</strong>. From every model result, the soil
<em>efflux</em> and other parameters can be extracted. Further functions
help improve and analyse the models.</p>
<p>This framework is designed to be as modular as possible, so that any
kind of approach can be implemented. Each function has documentation
attached (<code>?my_function</code>) to help setting up the data and the
models. In the next chapter a typical workflow will be presented using
synthetic datasets that are included in the package.</p>
<div class="grViz html-widget html-fill-item" id="htmlwidget-ac96cb3ee4656e2e9ec3" style="width:700px;height:432.632880098888px;"></div>
<script type="application/json" data-for="htmlwidget-ac96cb3ee4656e2e9ec3">{"x":{"diagram":"digraph flowchart {\ngraph [layout = dot, rankdir = LR]\n\n\n  node [style = filled color = white shape = rectangle]\n  node [fillcolor = BlueViolet fontcolor = white]\n  a [label = \"gasdata\"]\n  b [label = \"soilphys\"]\n  c [label = \"layers_map\"]\n  h [label = \"cfp_dat\"]\n  m [label = \"cfp_fgres\"]\n  n [label = \"cfp_pfres\"]\n  o [label = \"EFFLUX\"]\n  p [label = \"PRODUCTION\"]\n  s [label = \"cfp_altres\"]\n  \n  \n  node [fillcolor = orange shape = oval fontcolor = black]\n  d [label = \"cfp_dat()\"]\n  e [label = \"cfp_gasdata()\"]\n  f [label = \"cfp_soilphys()\"]\n  g [label = \"cfp_layers_map()\"]\n  i [label = \"fg_flux()\"]\n  j [label = \"pro_flux()\"]\n  k [label = \"efflux()\"]\n  l [label = \"production()\"]\n  q [label = \"run_map()\"]\n  r [label = \"alternate()\"]\n  \n  a -> {e}\n  b -> {f}\n  c -> {g}\n  {e f g} -> d\n  d -> h\n  h -> {i j}\n  i -> m\n  j -> n\n  {m n} -> {k l r}\n  k -> o\n  l -> p\n  q -> r\n  r -> s\n  \n   subgraph clusterMain {\n   graph [rankdir = TB]\n   node [style = filled color = white shape = rectangle]\n  node [fillcolor = BlueViolet fontcolor = white]\n  aaa [label = \"objects\"]\n\n\n  node [fillcolor = orange shape = oval fontcolor = black]\n  bbb [label = \"functions()\"]\n   \n}\n  \n}\n \n  ","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script>
</div>
<div class="section level2">
<h2 id="general-workflow">General workflow<a class="anchor" aria-label="anchor" href="#general-workflow"></a>
</h2>
<div class="section level3">
<h3 id="data-preparation">data preparation<a class="anchor" aria-label="anchor" href="#data-preparation"></a>
</h3>
<p>There are two datasets required for a ConFluxPro flux model. One
giving information on the gas concentration profiles
(<code>gasdata</code>) and one on the physical properties and
diffusivity of the soil (<code>soilphys</code>). ConFluxPro ships a
synthetic example dataset to illustrate the form of the datasets
required. To access the datasets use the <code><a href="https://rdrr.io/r/utils/data.html" class="external-link">data()</a></code>
function:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://valentingar.github.io/ConFluxPro/">ConFluxPro</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'ConFluxPro'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">gasdata</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">soilphys</span><span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="gasdata">gasdata<a class="anchor" aria-label="anchor" href="#gasdata"></a>
</h4>
<p><code>gasdata</code> has three important columns: <code>depth</code>
gives the depth of the data entry in cm, <code>x_ppm</code> the
concentration in ppm and <code>gas</code> the type of the gas as a
character string. Any further columns may identify each profile. For the
example datasets, these include <code>site</code> as well as
<code>Date</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">gasdata</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 5</span></span></span>
<span><span class="co">#&gt;   site   Date       depth x_ppm gas  </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> site_a 2021-01-01     5  423. CO2  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> site_a 2021-01-01     0  552. CO2  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> site_a 2021-01-01     0  556. CO2  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> site_a 2021-01-01     0  557. CO2  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> site_a 2021-01-01   -<span style="color: #BB0000;">10</span>  716. CO2  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> site_a 2021-01-01   -<span style="color: #BB0000;">10</span>  713. CO2</span></span></code></pre></div>
<p>A profile is a single vertical snapshot of a soil column. Each
profile will result in a single efflux to / from the atmosphere.
Parameters that characterise each profile are <code>id_cols</code> in
ConFluxPro. To set up gasdata for a model, we run
<code><a href="../reference/cfp_gasdata.html">cfp_gasdata()</a></code>. Here, we have to define the
<code>id_cols</code> of the dataset. That is used to verify that the
dataset is ready, i.e. that there are no incomplete profiles. Otherwise,
an error is returned.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gasdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cfp_gasdata.html">cfp_gasdata</a></span><span class="op">(</span><span class="va">gasdata</span>, id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"site"</span>, <span class="st">"Date"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; added 'gas' to id_cols</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="soilphys">soilphys<a class="anchor" aria-label="anchor" href="#soilphys"></a>
</h4>
<p>The next part is to prepare the <code>soilphys</code> object. Each
profile is separated into discrete steps for which soil physical
parameters are defined. Each step has an upper and lower boundary that
cover the complete depth of the profile without overlapping and gaps. In
ConFluxPro, this is called <em>upper/lower consistency</em>. Each step
is considered homogeneous, which means that any parameter (e.g. total
pore space) is assumed constant within the step. For flux modeling,
<code>soilphys</code> needs to have the following columns:
<code>upper</code> and <code>lower</code> boundaries of each step in cm,
the apparent diffusion coefficient <code>DS</code> in m<sup>2</sup>
s<sup>-1</sup> and <code>gas</code>. To get to this place, there are
different functions that help set up such a dataset from different
sources (see <code><a href="../reference/discretize_depth.html">discretize_depth()</a></code> and
<code><a href="../reference/complete_soilphys.html">complete_soilphys()</a></code>), the example dataset is already in
shape, so that we can run <code><a href="../reference/cfp_soilphys.html">cfp_soilphys()</a></code> directly. Again,
any <code>id_cols</code> need to be defined.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">soilphys</span><span class="op">)</span></span>
<span><span class="co">#&gt;     site  TPS   a   b depth upper lower       Date        SWC            t    p</span></span>
<span><span class="co">#&gt; 1 site_a 0.38 1.2 1.5   -80   -60  -100 2021-01-01 0.16135277 -0.789903514 1013</span></span>
<span><span class="co">#&gt; 2 site_a 0.38 1.2 1.5   -80   -60  -100 2021-02-01 0.12392743  0.005814771 1013</span></span>
<span><span class="co">#&gt; 3 site_a 0.38 1.2 1.5   -80   -60  -100 2021-03-01 0.12227893  2.059937865 1013</span></span>
<span><span class="co">#&gt; 4 site_a 0.38 1.2 1.5   -80   -60  -100 2021-04-01 0.14464345  4.725217894 1013</span></span>
<span><span class="co">#&gt; 5 site_a 0.38 1.2 1.5   -80   -60  -100 2021-05-01 0.11446588  8.825682240 1013</span></span>
<span><span class="co">#&gt; 6 site_a 0.38 1.2 1.5   -80   -60  -100 2021-06-01 0.09537391 10.377836383 1013</span></span>
<span><span class="co">#&gt;        AFPS      DSD0 gas           D0           DS    c_air</span></span>
<span><span class="co">#&gt; 1 0.2186472 0.1226866 CO2 1.373780e-05 1.685444e-06 44.73588</span></span>
<span><span class="co">#&gt; 2 0.2560726 0.1554984 CO2 1.381053e-05 2.147515e-06 44.60556</span></span>
<span><span class="co">#&gt; 3 0.2577211 0.1570023 CO2 1.399908e-05 2.197889e-06 44.27263</span></span>
<span><span class="co">#&gt; 4 0.2353565 0.1370158 CO2 1.424543e-05 1.951850e-06 43.84798</span></span>
<span><span class="co">#&gt; 5 0.2655341 0.1641957 CO2 1.462819e-05 2.401886e-06 43.21035</span></span>
<span><span class="co">#&gt; 6 0.2846261 0.1822189 CO2 1.477426e-05 2.692149e-06 42.97380</span></span>
<span></span>
<span><span class="va">soilphys</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cfp_soilphys.html">cfp_soilphys</a></span><span class="op">(</span><span class="va">soilphys</span>, id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"site"</span>, <span class="st">"Date"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; added 'gas' to id_cols</span></span></code></pre></div>
<p><code><a href="../reference/cfp_soilphys.html">cfp_soilphys()</a></code> checks for upper/lower consistency and
other indicators of data integrety. Should your data fail here (and
<code><a href="../reference/cfp_soilphys.html">cfp_soilphys()</a></code> return an error), make sure that you have
only a single entry per step and profile (idfentified by the
<code>id_cols</code> provided) and that your steps are not overlapping
and without gaps.</p>
</div>
<div class="section level4">
<h4 id="layers_map">layers_map<a class="anchor" aria-label="anchor" href="#layers_map"></a>
</h4>
<p>The final puzzle-piece for a model-ready dataset is
<code>layers_map</code>. Here, any <em>layers</em> are defined, for
which fluxes should be calculated independently or, in the case of the
inverse approach, production rates should be optimised. This means, that
different <code>layers_map</code> can be defined and tried out. Layers
are defined by an <code>upper</code> and <code>lower</code> boundary in
cm. For now, we will consider two layers per site: One in the Humus
layer (here: depth &gt; 0 cm) and one in the mineral soil (depth &lt; 0
cm):</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="va">layers_map</span> <span class="op">&lt;-</span> </span>
<span>    <span class="va">soilphys</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># use limits of soilphys per site</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">upper</span>,<span class="va">site</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">site</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice_max</a></span><span class="op">(</span><span class="va">upper</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">upper</span>,<span class="fl">0</span><span class="op">)</span>,</span>
<span>              lower <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="op">-</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="co">#&gt; Warning: Returning more (or less) than 1 row per `summarise()` group was deprecated in</span></span>
<span><span class="co">#&gt; dplyr 1.1.0.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Please use `reframe()` instead.</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> When switching from `summarise()` to `reframe()`, remember that `reframe()`</span></span>
<span><span class="co">#&gt;   always returns an ungrouped data frame and adjust accordingly.</span></span>
<span><span class="co">#&gt; <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">#&gt; <span style="color: #555555;">generated.</span></span></span>
<span><span class="co">#&gt; `summarise()` has grouped output by 'site'. You can override using the</span></span>
<span><span class="co">#&gt; `.groups` argument.</span></span>
<span></span>
<span>  <span class="va">layers_map</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 3</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># Groups:   site [2]</span></span></span>
<span><span class="co">#&gt;   site   upper lower</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> site_a     5     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> site_a     0  -<span style="color: #BB0000;">100</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> site_b     7     0</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> site_b     0  -<span style="color: #BB0000;">100</span></span></span></code></pre></div>
<p>Using <code><a href="../reference/cfp_layers_map.html">cfp_layers_map()</a></code> the data is checked for integrity
and further model-specific parameters defined.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">layers_map</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/cfp_layers_map.html">cfp_layers_map</a></span><span class="op">(</span></span>
<span>    <span class="va">layers_map</span>,</span>
<span>    gas <span class="op">=</span> <span class="st">"CO2"</span>,</span>
<span>    id_cols <span class="op">=</span> <span class="st">"site"</span>,</span>
<span>    layer_couple <span class="op">=</span> <span class="fl">0</span>,  <span class="co"># only for pro_flux()</span></span>
<span>    lowlim <span class="op">=</span> <span class="fl">0</span>,        <span class="co">#   </span></span>
<span>    highlim <span class="op">=</span> <span class="fl">1000</span>     <span class="co">#</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; added 'gas' to id_cols</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="binding-it-all-together-cfp_dat">Binding it all together: cfp_dat()<a class="anchor" aria-label="anchor" href="#binding-it-all-together-cfp_dat"></a>
</h4>
<p>The centrepiece of every ConFluxPro model is a <code>cfp_dat</code>
object. <code><a href="../reference/cfp_dat.html">cfp_dat()</a></code> takes a <code>cfp_gasdata</code>,
<code>cfp_soilphys</code> and <code>cfp_layers_map</code> object and
connects the different datasets together. For all combinations of
<code>id_cols</code> within the datasets, a single <code>prof_id</code>
is defined and each profile checked for integrity. This means, that for
each profile, the three datasets need to match: The lowest and highest
<code>depth</code> of <code>gasdata</code> must exactly match the
highest and lowest <code>upper</code> and <code>lower</code> boundary of
<code>soilphys</code> and <code>layers_map</code>. Each profile must be
complete, meaning that all three corresponding datasets must be matched
uniquely per profile. This does not mean, that the <code>id_cols</code>
must be the same for the datasets, only that they must be mappable to
the other datasets. E.g. notice, that <code>layers_map</code> is missing
the <code>id_cols</code> <code>"Date"</code>, which is no problem,
because it can still be matched using <code>"site"</code>. If everything
is ready, run <code><a href="../reference/cfp_dat.html">cfp_dat()</a></code> to join the datasets together. If
the data is not yet ready, the function will giv information about
missing / not matching data.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cfp_dat.html">cfp_dat</a></span><span class="op">(</span><span class="va">gasdata</span>,</span>
<span>                  <span class="va">soilphys</span>,</span>
<span>                  <span class="va">layers_map</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; validating datasets</span></span>
<span><span class="co">#&gt; id_cols: site, Date, gas</span></span>
<span><span class="co">#&gt; 24 unique profiles</span></span></code></pre></div>
<p>A <code>cfp_dat</code> object is essentially a list of the original
datasets and a fourth <code>data.frame</code> that has information on
each single profile defined by the <code>ìd_cols</code>. This means,
that all the elements can be accessed using the normal <code>$</code>
operator:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dat</span><span class="op">$</span><span class="va">layers_map</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_layers_map object </span></span>
<span><span class="co">#&gt; id_cols: site gas </span></span>
<span><span class="co">#&gt; 2  unique profiles </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     site upper lower gas lowlim highlim layer_couple layer pmap group_id</span></span>
<span><span class="co">#&gt; 1 site_a     0  -100 CO2      0    1000            0     1    1        1</span></span>
<span><span class="co">#&gt; 2 site_b     0  -100 CO2      0    1000            0     1    1        2</span></span>
<span><span class="co">#&gt; 3 site_a     5     0 CO2      0    1000            0     2    2        1</span></span>
<span><span class="co">#&gt; 4 site_b     7     0 CO2      0    1000            0     2    2        2</span></span></code></pre></div>
<p>In the <code>profiles</code> <code>data.frame</code>, each row
corresponds to a single profile with the corresponding
<code>id_cols</code>, as well as ids, mapping the profile in the other
datasets: <code>sp_id</code> for <code>soilphys</code>,
<code>gd_id</code> for <code>gasdata</code> and <code>group_id</code>
for <code>layers_map</code>.</p>
<p>When printing a <code>cfp_dat</code> object, the most relevant
information is displayed:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dat</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_dat object to be used as input in ConFluxPro models. </span></span>
<span><span class="co">#&gt; id_cols: site Date gas </span></span>
<span><span class="co">#&gt; number of profiles:  24 </span></span>
<span><span class="co">#&gt; number of groups:  2</span></span></code></pre></div>
<p>Different dplyr-like methods are implemented. Model data can be
subsampled using <code><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter()</a></code>. Any columns of the
<code>profiles</code> data.frame can be used for filtering (This ensures
that only complete profiles are filtered).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">site</span> <span class="op">==</span> <span class="st">"site_a"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_dat object to be used as input in ConFluxPro models. </span></span>
<span><span class="co">#&gt; id_cols: site Date gas </span></span>
<span><span class="co">#&gt; number of profiles:  12 </span></span>
<span><span class="co">#&gt; number of groups:  1</span></span>
<span></span>
<span><span class="va">my_dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Date</span> <span class="op">&lt;</span> <span class="st">"2021-04-01"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_dat object to be used as input in ConFluxPro models. </span></span>
<span><span class="co">#&gt; id_cols: site Date gas </span></span>
<span><span class="co">#&gt; number of profiles:  6 </span></span>
<span><span class="co">#&gt; number of groups:  2</span></span>
<span></span>
<span></span>
<span><span class="va">my_dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">prof_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">23</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_dat object to be used as input in ConFluxPro models. </span></span>
<span><span class="co">#&gt; id_cols: site Date gas </span></span>
<span><span class="co">#&gt; number of profiles:  3 </span></span>
<span><span class="co">#&gt; number of groups:  2</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="models">Models<a class="anchor" aria-label="anchor" href="#models"></a>
</h3>
<div class="section level4">
<h4 id="flux-gradient-method-fgm-with-fg_flux">Flux-Gradient-Method FGM with fg_flux()<a class="anchor" aria-label="anchor" href="#flux-gradient-method-fgm-with-fg_flux"></a>
</h4>
<p>The ‘classic’ approach of calculating fluxes from concentration
profiles is to estimate the gradient of a gas along its direction of
diffusion and use Fick’s law:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>F</mi><mo>=</mo><mo>−</mo><msub><mi>D</mi><mi>s</mi></msub><mo>⋅</mo><mfrac><mrow><mi>d</mi><mi>c</mi></mrow><mrow><mi>d</mi><mi>z</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">
F = - D_s \cdot \frac{dc}{dz}
</annotation></semantics></math> This is implemented in ConFluxPro in
the <code><a href="../reference/fg_flux.html">fg_flux()</a></code> function. Within each layer defined in
<code>layers_map</code>, the gradient is estimated. The corresponding
diffusion coefficient is the harmonic mean of the apparent diffusion
coefficient within this layer, weighed by the height of each step within
<code>soilphys</code>. Different methods are implemented to estimate the
gradient, e.g. a linear spline method, local linear regression and so
on. These can be defined in the function call. For now, let’s use a
linear spline function to estimate the gradients within the humus and
mineral soil layer we defined beforehand:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">FLUX</span> <span class="op">&lt;-</span></span>
<span><span class="va">my_dat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/fg_flux.html">fg_flux</a></span><span class="op">(</span>gases <span class="op">=</span> <span class="st">"CO2"</span>, </span>
<span>          modes <span class="op">=</span> <span class="st">"LS"</span>, <span class="co"># use linear spline to estimate gradient </span></span>
<span>          param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"c_air"</span>, <span class="st">"DS"</span><span class="op">)</span>, <span class="co"># soilphys parameters averaged per layer</span></span>
<span>          funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"arith"</span>, <span class="st">"harm"</span><span class="op">)</span> <span class="co"># averaging function corresponding to param</span></span>
<span>          <span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; validating datasets</span></span>
<span><span class="co">#&gt; id_cols: site, Date, gas</span></span>
<span><span class="co">#&gt; 24 unique profiles</span></span></code></pre></div>
<p>The resulting object stores all the input datasets and parameters and
the flux results are only added to the list of data.frames and can thus
be accessed by running <code>FLUX$FLUX</code>. The advantage of keeping
the input parameters is twofold: a) you always can check the parameters
that produced the model result and b) it makes it easy to tweak things
and try again. This also means that we can rerun the model with a simple
command:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/fg_flux.html">fg_flux</a></span><span class="op">(</span><span class="va">FLUX</span><span class="op">)</span> <span class="co"># all the information is already there</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_fgres fg_flux model result. </span></span>
<span><span class="co">#&gt; mean R2 achieved:  0.934057 </span></span>
<span><span class="co">#&gt; number of failed fits:  0 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_fgmod fg_flux model. </span></span>
<span><span class="co">#&gt; gases: CO2  </span></span>
<span><span class="co">#&gt; modes:  LS  </span></span>
<span><span class="co">#&gt; param:  c_air DS  </span></span>
<span><span class="co">#&gt; funs:  arith harm  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_dat object to be used as input in ConFluxPro models. </span></span>
<span><span class="co">#&gt; id_cols: site Date gas </span></span>
<span><span class="co">#&gt; number of profiles:  24 </span></span>
<span><span class="co">#&gt; number of groups:  2</span></span></code></pre></div>
<p>Let’s visualise the results using ggplot:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">FLUX</span><span class="op">$</span><span class="va">FLUX</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">FLUX</span><span class="op">$</span><span class="va">profiles</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># here is the info about the Date and site we need</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Date</span>, y <span class="op">=</span> <span class="va">flux</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">layer</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span>rows <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">site</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">'bottom'</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(prof_id, gas)`</span></span></code></pre></div>
<p><img src="overview_files/figure-html/unnamed-chunk-17-1.png" width="700">
The layer numbering always starts at the bottom, so that 1 (red) denotes
the mineral soil and 2 (blue) the humus layer.</p>
</div>
<div class="section level4">
<h4 id="inverse-flux-moddeling-pro_flux">Inverse Flux moddeling pro_flux()<a class="anchor" aria-label="anchor" href="#inverse-flux-moddeling-pro_flux"></a>
</h4>
<p>A different approach is implemented in ConFluxPro using inverse
modelling. Assuming that a gas is only either produced or consumed
within a soil homogeneous step of soil and the relevant fluxes at its
boundaries are known, the concentration profile of a gas can be
calculated as follows:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>−</mo><mfrac><mi>P</mi><mrow><mn>2</mn><mo>⋅</mo><msub><mi>D</mi><mi>S</mi></msub></mrow></mfrac><mo>⋅</mo><msup><mi>z</mi><mn>2</mn></msup><mo>−</mo><mfrac><msub><mi>F</mi><mrow><mi>i</mi><mi>n</mi></mrow></msub><msub><mi>D</mi><mi>S</mi></msub></mfrac><mo>⋅</mo><mi>z</mi><mo>+</mo><msub><mi>C</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">
C(z) = -\frac{P}{2 \cdot D_S} \cdot z^2 -\frac{F_{in}}{D_S} \cdot z + C_0
</annotation></semantics></math> where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>z</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">C(z)</annotation></semantics></math>
is the concentration at a height
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>z</mi><annotation encoding="application/x-tex">z</annotation></semantics></math>,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>P</mi><annotation encoding="application/x-tex">P</annotation></semantics></math>
is the production rate and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>F</mi><mrow><mi>i</mi><mi>n</mi></mrow></msub><annotation encoding="application/x-tex">F_{in}</annotation></semantics></math>
the incoming flux and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>C</mi><mn>0</mn></msub><annotation encoding="application/x-tex">C_0</annotation></semantics></math>
the concentration at the lower boundary. In ConFluxPro, this is solved
for each step of soil in <code>soilphys</code>. The production rates in
different layers in the soil are then optimised so that the resulting
concentration profile fits the <code>gasdata</code> best. For this,
lower and upper limits of the production rates have to be defined, that
are stored in <code>layers_map</code> and can be different for different
layers. Within each layer, the same production rate is assumed, so that
the total degrees of freedom of the optimisation depend on the number of
layers defined in <code>layers_map</code>.</p>
<p>Let’s have a look at the layers_map we defined before again.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dat</span><span class="op">$</span><span class="va">layers_map</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_layers_map object </span></span>
<span><span class="co">#&gt; id_cols: site gas </span></span>
<span><span class="co">#&gt; 2  unique profiles </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     site upper lower gas lowlim highlim layer_couple layer pmap group_id</span></span>
<span><span class="co">#&gt; 1 site_a     0  -100 CO2      0    1000            0     1    1        1</span></span>
<span><span class="co">#&gt; 2 site_b     0  -100 CO2      0    1000            0     1    1        2</span></span>
<span><span class="co">#&gt; 3 site_a     5     0 CO2      0    1000            0     2    2        1</span></span>
<span><span class="co">#&gt; 4 site_b     7     0 CO2      0    1000            0     2    2        2</span></span></code></pre></div>
<p>The lower and upper limits for the optimisation are in the columns
<code>lowlim</code> and <code>highlim</code>. Here, we assume that CO[2]
is only produced within the soil, so that we set the lower limit to 0.
The column <code>pmap</code> identifies each layer and can be later
retrieved in the <code>PROFLUX</code> or <code>soilphys</code>
<code>data.frame</code> starting with 1 at the bottom.</p>
<p>With that, we are all set and can calculate the fluxes using
<code><a href="../reference/pro_flux.html">pro_flux()</a></code>:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PROFLUX</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/pro_flux.html">pro_flux</a></span><span class="op">(</span><span class="va">my_dat</span><span class="op">)</span></span></code></pre></div>
<p>As with the ‘classic’ approach, the model result is the same as the
model input with an added dataset <code>PROFLUX</code>, so that we can
simply run the model again with:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pro_flux.html">pro_flux</a></span><span class="op">(</span><span class="va">PROFLUX</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_pfres pro_flux model result. </span></span>
<span><span class="co">#&gt; mean RMSE achieved:  0.035769 </span></span>
<span><span class="co">#&gt; number of failed fits:  0 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_pfmod pro_flux model. </span></span>
<span><span class="co">#&gt; zero_flux: TRUE  </span></span>
<span><span class="co">#&gt; zero_limits:  -Inf Inf  </span></span>
<span><span class="co">#&gt; DSD0_optim:  FALSE  </span></span>
<span><span class="co">#&gt; evenness_factor:  0  </span></span>
<span><span class="co">#&gt; known_flux_factor:  0  </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_dat object to be used as input in ConFluxPro models. </span></span>
<span><span class="co">#&gt; id_cols: site Date gas </span></span>
<span><span class="co">#&gt; number of profiles:  24 </span></span>
<span><span class="co">#&gt; number of groups:  2</span></span></code></pre></div>
<p>The model results are stored in</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PROFLUX</span><span class="op">$</span><span class="va">PROFLUX</span></span></code></pre></div>
<p>Which has the same structure as <code>soilphys</code> with added
columns <code>prod</code> giving the production rate within that step
and <code>conc</code> giving the concentration at the upper boundary of
the step.</p>
<p>Lets’s visualise again, but this time we can use the production per
layer directly:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PROFLUX</span><span class="op">$</span><span class="va">PROFLUX</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">PROFLUX</span><span class="op">$</span><span class="va">profiles</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>layer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">pmap</span> <span class="op">==</span> <span class="fl">2</span>, <span class="st">"humus"</span>, <span class="st">"mineral"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         flux <span class="op">=</span> <span class="va">prod</span><span class="op">*</span><span class="op">(</span><span class="va">upper</span><span class="op">-</span><span class="va">lower</span><span class="op">)</span><span class="op">/</span> <span class="fl">100</span> <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># calculating absolute production per step</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Date</span>, y <span class="op">=</span> <span class="va">flux</span>, </span>
<span>             fill <span class="op">=</span> <span class="va">layer</span><span class="op">)</span><span class="op">)</span><span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_bar</a></span><span class="op">(</span>stat <span class="op">=</span> <span class="st">'identity'</span>, position <span class="op">=</span> <span class="st">'stack'</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span>rows <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">site</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Joining with `by = join_by(prof_id, sp_id)`</span></span></code></pre></div>
<p><img src="overview_files/figure-html/unnamed-chunk-22-1.png" width="700">
Because this evaluation is often the first thing we want to do after a
<code>pro_flux</code> model is complete, there is a convenient function
<code><a href="../reference/production.html">production()</a></code> that automates this process, where the column
<code>prod_abs</code> gives the same information that we calculated as
<code>flux</code> above.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/production.html">production</a></span><span class="op">(</span><span class="va">PROFLUX</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_layered_profile object </span></span>
<span><span class="co">#&gt; id_cols: site Date gas </span></span>
<span><span class="co">#&gt; 3  unique profiles </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     site       Date gas upper lower layer   prod_abs   prod_rel    efflux F0</span></span>
<span><span class="co">#&gt; 1 site_a 2021-01-01 CO2     0  -100     1 0.09704722 0.11626198 0.8347288  0</span></span>
<span><span class="co">#&gt; 2 site_a 2021-01-01 CO2     5     0     2 0.73768158 0.88373802 0.8347288  0</span></span>
<span><span class="co">#&gt; 3 site_b 2021-01-01 CO2     0  -100     1 0.05406110 0.08019349 0.6741332  0</span></span>
<span><span class="co">#&gt; 4 site_b 2021-01-01 CO2     7     0     2 0.62007213 0.91980651 0.6741332  0</span></span>
<span><span class="co">#&gt; 5 site_a 2021-02-01 CO2     0  -100     1 0.14909176 0.10904179 1.3672901  0</span></span>
<span><span class="co">#&gt; 6 site_a 2021-02-01 CO2     5     0     2 1.21819835 0.89095821 1.3672901  0</span></span>
<span><span class="co">#&gt;   DELTA_F0 DELTA_prod_abs DELTA_prod_rel</span></span>
<span><span class="co">#&gt; 1       NA             NA             NA</span></span>
<span><span class="co">#&gt; 2       NA             NA             NA</span></span>
<span><span class="co">#&gt; 3       NA             NA             NA</span></span>
<span><span class="co">#&gt; 4       NA             NA             NA</span></span>
<span><span class="co">#&gt; 5       NA             NA             NA</span></span>
<span><span class="co">#&gt; 6       NA             NA             NA</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="extract-and-calculate-the-efflux">Extract and calculate the efflux()<a class="anchor" aria-label="anchor" href="#extract-and-calculate-the-efflux"></a>
</h4>
<p>No matter the approach, one goal is often to estimate the efflux of a
gas at the atmosphere/soil interface. This can be done using the
<code><a href="../reference/efflux.html">efflux()</a></code> function. For a <code><a href="../reference/pro_flux.html">pro_flux()</a></code> model
result, this is straightforward, as the efflux is simply the sum of the
production within the soil that was optimised. Thus, the efflux can be
directly estimated:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">PF_EFFLUX</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/efflux.html">efflux</a></span><span class="op">(</span><span class="va">PROFLUX</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">PF_EFFLUX</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_profile object </span></span>
<span><span class="co">#&gt; id_cols: site Date gas </span></span>
<span><span class="co">#&gt; 6  unique profiles </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     site       Date gas    efflux prof_id</span></span>
<span><span class="co">#&gt; 1 site_a 2021-01-01 CO2 0.8347288       1</span></span>
<span><span class="co">#&gt; 2 site_b 2021-01-01 CO2 0.6741332       2</span></span>
<span><span class="co">#&gt; 3 site_a 2021-02-01 CO2 1.3672901       3</span></span>
<span><span class="co">#&gt; 4 site_b 2021-02-01 CO2 1.0613224       4</span></span>
<span><span class="co">#&gt; 5 site_a 2021-03-01 CO2 1.7443084       5</span></span>
<span><span class="co">#&gt; 6 site_b 2021-03-01 CO2 1.3906597       6</span></span></code></pre></div>
<p>For a model result from <code><a href="../reference/fg_flux.html">fg_flux()</a></code>, this needs some more
consideration. One option is to extrapolate the soil internal fluxes
from to the top of the soil using linear regression. This can be defined
in the call to <code>efflux</code>:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">FG_EFFLUX</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/efflux.html">efflux</a></span><span class="op">(</span><span class="va">FLUX</span>, </span>
<span>                    method <span class="op">=</span> <span class="st">"lm"</span><span class="op">)</span> <span class="co"># using a linear regression.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">FG_EFFLUX</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_profile object </span></span>
<span><span class="co">#&gt; id_cols: site Date gas </span></span>
<span><span class="co">#&gt; 6  unique profiles </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   mode prof_id    efflux   site       Date gas</span></span>
<span><span class="co">#&gt; 1   LS       1 0.5774565 site_a 2021-01-01 CO2</span></span>
<span><span class="co">#&gt; 2   LS       2 0.3993311 site_b 2021-01-01 CO2</span></span>
<span><span class="co">#&gt; 3   LS       3 0.9335609 site_a 2021-02-01 CO2</span></span>
<span><span class="co">#&gt; 4   LS       4 0.6259608 site_b 2021-02-01 CO2</span></span>
<span><span class="co">#&gt; 5   LS       5 1.2242680 site_a 2021-03-01 CO2</span></span>
<span><span class="co">#&gt; 6   LS       6 0.8429107 site_b 2021-03-01 CO2</span></span></code></pre></div>
<p>Let’s see how the two models differ:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">FG_EFFLUX</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"classic"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">PF_EFFLUX</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model <span class="op">=</span> <span class="st">"inverse"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Date</span>, y <span class="op">=</span> <span class="va">efflux</span>, col <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span>rows <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">site</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="overview_files/figure-html/unnamed-chunk-26-1.png" width="700">
As we can see, the inverse approach estimated higher efflux, while
models showed the same relative dynamics across the datasets.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="outlook">Outlook<a class="anchor" aria-label="anchor" href="#outlook"></a>
</h2>
<p>Here ends this short overview over the most important functions and
workflows in ConFluxPro. Check out the other vignettes of this package
to learn more about <strong>further model analysis</strong> or
<strong>data preparation</strong>.</p>
<p><em>Thank you for your interest in the package and good luck with
your research!</em></p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Valentin Gartiser.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
