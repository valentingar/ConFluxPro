<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Data preparation • ConFluxPro</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Data preparation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ConFluxPro</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/ConFluxPro.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/data_preparation.html">Data preparation</a></li>
    <li><a class="dropdown-item" href="../articles/flux.html">Flux calculation</a></li>
    <li><a class="dropdown-item" href="../articles/calibration.html">Calibration</a></li>
    <li><a class="dropdown-item" href="../articles/uncertainty.html">Uncertainty estimation</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/valentingar/confluxpro/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Data preparation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/valentingar/confluxpro/blob/main/vignettes/data_preparation.Rmd" class="external-link"><code>vignettes/data_preparation.Rmd</code></a></small>
      <div class="d-none name"><code>data_preparation.Rmd</code></div>
    </div>

    
    
<p>This vignette introduces the central data classes in
<em>ConFluxPro</em> and shows how to combine all necessary data into a
single <code><a href="../reference/cfp_dat.html">cfp_dat()</a></code> object. We start by explaining the concept
of a ‘profile’ and how soil data is structured in the package. We then
introduce three essential classes <code><a href="../reference/cfp_gasdata.html">cfp_gasdata()</a></code>,
<code><a href="../reference/cfp_soilphys.html">cfp_soilphys()</a></code> and <code><a href="../reference/cfp_layers_map.html">cfp_layers_map()</a></code> that frame
different data types within <em>ConFluxPro</em>. Finally, we combine
these objects into a single <code><a href="../reference/cfp_dat.html">cfp_dat()</a></code> object that holds all
information needed to start modeling soil gas fluxes.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://confluxpro.valentingartiser.de/" class="external-link">ConFluxPro</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="soil-data-and-profiles">Soil data and profiles<a class="anchor" aria-label="anchor" href="#soil-data-and-profiles"></a>
</h2>
<div class="section level3">
<h3 id="what-is-a-soil-profile">What is a soil profile?<a class="anchor" aria-label="anchor" href="#what-is-a-soil-profile"></a>
</h3>
<p>A profile in <em>ConFluxPro</em> is a distinct observation of the
vertical profile of a soil. For example, this can mean the concentration
profile of CO<sub>2</sub> at a specific time point, or the vertical
distribution of soil moisture. Profiles are identified by their
<code>id_cols</code>, column names that together uniquely identify each
profile. This can be whatever combination of columns happened to be in
your data, but will typically include a datetime column to identify the
time point or a column that identifies the site if you measured at
multiple locations. Consider the <code>soilphys</code> dataset included
in the package.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"soilphys"</span>, package <span class="op">=</span> <span class="st">"ConFluxPro"</span><span class="op">)</span></span>
<span><span class="va">soilphys</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">site</span>, <span class="va">Date</span>, <span class="va">gas</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt;     site       Date gas  TPS   a   b depth upper lower        SWC            t</span></span>
<span><span class="co">#&gt; 1 site_a 2021-01-01 CO2 0.38 1.2 1.5   -80   -60  -100 0.16135277 -0.789903514</span></span>
<span><span class="co">#&gt; 2 site_a 2021-02-01 CO2 0.38 1.2 1.5   -80   -60  -100 0.12392743  0.005814771</span></span>
<span><span class="co">#&gt; 3 site_a 2021-03-01 CO2 0.38 1.2 1.5   -80   -60  -100 0.12227893  2.059937865</span></span>
<span><span class="co">#&gt; 4 site_a 2021-04-01 CO2 0.38 1.2 1.5   -80   -60  -100 0.14464345  4.725217894</span></span>
<span><span class="co">#&gt; 5 site_a 2021-05-01 CO2 0.38 1.2 1.5   -80   -60  -100 0.11446588  8.825682240</span></span>
<span><span class="co">#&gt; 6 site_a 2021-06-01 CO2 0.38 1.2 1.5   -80   -60  -100 0.09537391 10.377836383</span></span>
<span><span class="co">#&gt;      p      AFPS      DSD0           D0           DS    c_air</span></span>
<span><span class="co">#&gt; 1 1013 0.2186472 0.1226866 1.373780e-05 1.685444e-06 44.73588</span></span>
<span><span class="co">#&gt; 2 1013 0.2560726 0.1554984 1.381053e-05 2.147515e-06 44.60556</span></span>
<span><span class="co">#&gt; 3 1013 0.2577211 0.1570023 1.399908e-05 2.197889e-06 44.27263</span></span>
<span><span class="co">#&gt; 4 1013 0.2353565 0.1370158 1.424543e-05 1.951850e-06 43.84798</span></span>
<span><span class="co">#&gt; 5 1013 0.2655341 0.1641957 1.462819e-05 2.401886e-06 43.21035</span></span>
<span><span class="co">#&gt; 6 1013 0.2846261 0.1822189 1.477426e-05 2.692149e-06 42.97380</span></span></code></pre></div>
<p>This dataset contains information on different soil physical
parameters. We will come back to that later. For now, notice that there
are the <code>site</code> and <code>Date</code> column. All combinations
identify a unique profile, namely twelve dates for two sites
<code>"site_a"</code> and <code>"site_b"</code> for a total of 24
profiles. We can create a <code><a href="../reference/cfp_profile.html">cfp_profile()</a></code> object from this
dataset. The only thing this does is to add the information which
columns identify the profiles to the dataset with the
<code>id_cols</code> argument. Internally, the number of distinct
profiles is calculated as the unique combinations of the
<code>id_cols</code> and can be accessed by
<code><a href="../reference/utility.html">n_profiles()</a></code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">soilphys</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="../reference/cfp_profile.html">cfp_profile</a></span><span class="op">(</span><span class="va">soilphys</span>, id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"site"</span>, <span class="st">"Date"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/utility.html">n_profiles</a></span><span class="op">(</span><span class="va">soilphys</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 24</span></span></code></pre></div>
<p>The concept of profiles and <code>id_cols</code> applies to almost
all objects created in ConFluxPro. You can always see what
<code>id_cols</code> an object has by calling the function
<code><a href="../reference/extractors.html">cfp_id_cols()</a></code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/extractors.html">cfp_id_cols</a></span><span class="op">(</span><span class="va">soilphys</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "site" "Date"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="soil-data-structure">Soil data structure<a class="anchor" aria-label="anchor" href="#soil-data-structure"></a>
</h3>
<p>Within a soil profile, parameters change with depth. In ConFluxPro we
differentiate between two types of data. <em>Point data</em> have
distinct values at a precise <code>depth</code> in the soil, such as the
soil gas concentration. For <em>layered data</em> , the soil is
subdivided into layers that are delimited by their <code>upper</code>
and <code>lower</code> boundary. Layered data must be without gaps or
overlaps, so that the entire profile can be described by distinct
values. <code>depth</code>, <code>upper</code> and <code>lower</code>
are in centimeters and a higher value indicates the upward direction.
Both positive and negative values are allowed. This means you could set
the mineral/organic soil boundary to have <code>depth = 0</code>,
describe the mineral soil with increasingly negative values of
<code>depth</code> and have the organic layer on top have positive
values.</p>
<p>We will now present the three main data types that are needed to
model gas fluxes.</p>
</div>
</div>
<div class="section level2">
<h2 id="cfp_gasdata-gas-concentration-data">
<code>cfp_gasdata()</code>: Gas concentration data<a class="anchor" aria-label="anchor" href="#cfp_gasdata-gas-concentration-data"></a>
</h2>
<p>Soil gas concentration data is stored in a <code>data.frame</code>.
The data needs to have at least the columns <code>gas</code>,
<code>depth</code> and <code>x_ppm</code>, as well as any
<code>id_cols</code> that identify the soil profiles. The
<code>gas</code> is a <code><a href="https://rdrr.io/r/base/character.html" class="external-link">character()</a></code> that identifies which gas
was measured, so for example <code>"CO2"</code>. <code>depth</code> is
as explained above and <code>x_ppm</code> is the mixing ratio in ppm.
Consider the example data that ships with the package:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"gasdata"</span>, package <span class="op">=</span> <span class="st">"ConFluxPro"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">gasdata</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 5</span></span></span>
<span><span class="co">#&gt;   site   Date       depth x_ppm gas  </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;date&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> site_a 2021-01-01     5  423. CO2  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> site_a 2021-01-01     0  552. CO2  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> site_a 2021-01-01     0  556. CO2  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> site_a 2021-01-01     0  557. CO2  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> site_a 2021-01-01   -<span style="color: #BB0000;">10</span>  716. CO2  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> site_a 2021-01-01   -<span style="color: #BB0000;">10</span>  713. CO2</span></span></code></pre></div>
<p>Because this <code>data.frame</code> already follows the requirements
defined above, we can create a <code><a href="../reference/cfp_gasdata.html">cfp_gasdata()</a></code> object right
away by providing the necessary <code>id_cols</code>. The function
checks, whether the <code>data.frame</code> meets the criteria and
returns an object of class <code>cfp_gasdata</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create working cfp_gasdata object</span></span>
<span><span class="va">my_gasdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cfp_gasdata.html">cfp_gasdata</a></span><span class="op">(</span><span class="va">gasdata</span>, id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"site"</span>, <span class="st">"Date"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; added 'gas' to id_cols</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">my_gasdata</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_gasdata object </span></span>
<span><span class="co">#&gt; id_cols: site Date gas </span></span>
<span><span class="co">#&gt; 1  unique profiles </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     site       Date depth    x_ppm gas</span></span>
<span><span class="co">#&gt; 1 site_a 2021-01-01     5 422.7419 CO2</span></span>
<span><span class="co">#&gt; 2 site_a 2021-01-01     0 552.1412 CO2</span></span>
<span><span class="co">#&gt; 3 site_a 2021-01-01     0 555.8525 CO2</span></span>
<span><span class="co">#&gt; 4 site_a 2021-01-01     0 556.9315 CO2</span></span>
<span><span class="co">#&gt; 5 site_a 2021-01-01   -10 716.4256 CO2</span></span>
<span><span class="co">#&gt; 6 site_a 2021-01-01   -10 713.3633 CO2</span></span>
<span></span>
<span><span class="co"># won't work, because depth is missing</span></span>
<span><span class="va">gasdata_broken</span> <span class="op">&lt;-</span> <span class="va">gasdata</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="va">depth</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/cfp_gasdata.html">cfp_gasdata</a></span><span class="op">(</span><span class="va">gasdata_broken</span>, id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"site"</span>, <span class="st">"Date"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; added 'gas' to id_cols</span></span>
<span><span class="co">#&gt; Error in validate_cfp_gasdata(x): data.frame lacks obligatory columns</span></span></code></pre></div>
<p>The data is in a long format, following the <a href="https://tidyr.tidyverse.org/articles/tidy-data.html" class="external-link">tidy data
principles</a>, where each observation is in a new row. If your data is
not in this format, you can use the <code><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">tidyr::pivot_longer()</a></code>
and other functions in the <code>tidyr</code> package. Notice that
<code><a href="../reference/cfp_gasdata.html">cfp_gasdata()</a></code> automatically added the <code>gas</code>
column to the <code>id_cols</code>. <code>gas</code> is always a
required column in ConFluxPro, so that many functions will automatically
add it to the <code>id_cols</code> if its present and will fail if its
missing.</p>
</div>
<div class="section level2">
<h2 id="cfp_soilphys-soil-physical-data">
<code>cfp_soilphys()</code>: Soil physical data<a class="anchor" aria-label="anchor" href="#cfp_soilphys-soil-physical-data"></a>
</h2>
<div class="section level3">
<h3 id="create-a-cfp_soilphys-object">Create a <code>cfp_soilphys()</code> object<a class="anchor" aria-label="anchor" href="#create-a-cfp_soilphys-object"></a>
</h3>
<p>Soil physical data includes everything else needed to describe the
gas transport characteristics of the soil. This data is split into
homogeneous layers with constant values for each layer and profile. At
the minimum, <code><a href="../reference/cfp_soilphys.html">cfp_soilphys()</a></code> requires two parameters:
<code>DS</code> is the gas-specific apparent diffusion coefficient of
the soil in m<sup>2</sup> s<sup>-1</sup> and <code>c_air</code> is the
number density of the soil air in mol m<sup>-3</sup>. If these
parameters are provided, a valid <code>cfp_soilphys</code> object can be
created. This function ensures that each profile is correctly layered
without overlaps or gaps and that the required columns are present.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"soilphys"</span>, package <span class="op">=</span> <span class="st">"ConFluxPro"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">my_soilphys</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cfp_soilphys.html">cfp_soilphys</a></span><span class="op">(</span><span class="va">soilphys</span>, id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"site"</span>, <span class="st">"Date"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; added 'gas' to id_cols</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="derive-parameters-with-complete_soilphys">Derive parameters with <code>complete_soilphys()</code><a class="anchor" aria-label="anchor" href="#derive-parameters-with-complete_soilphys"></a>
</h3>
<p>Often <code>DS</code> and <code>c_air</code> are derived from other
parameters that are easier to measure. This then requires a bit more
work to get a working <code><a href="../reference/cfp_soilphys.html">cfp_soilphys()</a></code> object. Typically, you
will need the following information:</p>
<p><strong>Measured parameters:</strong></p>
<ul>
<li>
<code>TPS</code>: total porosity as a volume fraction.</li>
<li>
<code>SWC</code>: soil water content as a volume fraction.</li>
<li>
<code>t</code>: air temperature in °C.</li>
<li>
<code>p</code>: air pressure in hPa.</li>
</ul>
<p><strong>Derived parameters:</strong></p>
<ul>
<li><strong><code>c_air</code>: air number density, derived from
<code>t</code> and <code>p</code> with ideal gas law.</strong></li>
<li>
<code>AFPS</code>: air-filled pore space, defined as
<code>AFPS = TPS - SWC</code>.</li>
<li>
<code>DSD0</code>: relative diffusivity of the soil, unit-less.
Derived from <code>AFPS</code> with transfer function.</li>
<li>
<code>D0</code>: gas-specific free-air diffusion coefficient in
m<sup>2</sup> s<sup>-1</sup>. Derived from <code>t</code> and
<code>p</code> with empiric function.</li>
<li><strong><code>DS</code>: gas-specific apparent diffusion coefficient
in m<sup>2</sup> s<sup>-1</sup>, derived as
<code>DS = D0 * DSD0</code>.</strong></li>
</ul>
<p>These relationships are invoked within the
<code><a href="../reference/complete_soilphys.html">complete_soilphys()</a></code> function. Consider the provided example
data: It already has every parameter we need. Now let’s remove the
derived parameters and run <code><a href="../reference/complete_soilphys.html">complete_soilphys()</a></code> again. We
have to provide a formula for the calculation of the relative
diffusivity <code>DSD0</code>. In our case, we have fitting parameters
<code>a</code> and <code>b</code> from a Currie-style model that
calculates as <code>DSD0 = a * AFPS ^ b</code>. We provide this formula
as a <code><a href="https://rdrr.io/r/base/character.html" class="external-link">character()</a></code> to the function:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">soilphys_measured_only</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">soilphys</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AFPS"</span>, <span class="st">"DSD0"</span>, <span class="st">"D0"</span>, <span class="st">"DS"</span>, <span class="st">"c_air"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">soilphys_measured_only</span><span class="op">)</span></span>
<span><span class="co">#&gt;     site  TPS   a   b depth upper lower       Date        SWC            t    p</span></span>
<span><span class="co">#&gt; 1 site_a 0.38 1.2 1.5   -80   -60  -100 2021-01-01 0.16135277 -0.789903514 1013</span></span>
<span><span class="co">#&gt; 2 site_a 0.38 1.2 1.5   -80   -60  -100 2021-02-01 0.12392743  0.005814771 1013</span></span>
<span><span class="co">#&gt; 3 site_a 0.38 1.2 1.5   -80   -60  -100 2021-03-01 0.12227893  2.059937865 1013</span></span>
<span><span class="co">#&gt; 4 site_a 0.38 1.2 1.5   -80   -60  -100 2021-04-01 0.14464345  4.725217894 1013</span></span>
<span><span class="co">#&gt; 5 site_a 0.38 1.2 1.5   -80   -60  -100 2021-05-01 0.11446588  8.825682240 1013</span></span>
<span><span class="co">#&gt; 6 site_a 0.38 1.2 1.5   -80   -60  -100 2021-06-01 0.09537391 10.377836383 1013</span></span>
<span><span class="co">#&gt;   gas</span></span>
<span><span class="co">#&gt; 1 CO2</span></span>
<span><span class="co">#&gt; 2 CO2</span></span>
<span><span class="co">#&gt; 3 CO2</span></span>
<span><span class="co">#&gt; 4 CO2</span></span>
<span><span class="co">#&gt; 5 CO2</span></span>
<span><span class="co">#&gt; 6 CO2</span></span>
<span></span>
<span><span class="va">my_soilphys_completed</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="../reference/complete_soilphys.html">complete_soilphys</a></span><span class="op">(</span><span class="va">soilphys_measured_only</span>, DSD0_formula <span class="op">=</span> <span class="st">"a*AFPS^b"</span><span class="op">)</span></span>
<span><span class="co">#&gt; The following columns were added: AFPS DSD0 D0 DS c_air</span></span>
<span><span class="co">#&gt; The following columns were overwritten:</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">my_soilphys_completed</span><span class="op">)</span></span>
<span><span class="co">#&gt;     site  TPS   a   b depth upper lower       Date        SWC            t    p</span></span>
<span><span class="co">#&gt; 1 site_a 0.38 1.2 1.5   -80   -60  -100 2021-01-01 0.16135277 -0.789903514 1013</span></span>
<span><span class="co">#&gt; 2 site_a 0.38 1.2 1.5   -80   -60  -100 2021-02-01 0.12392743  0.005814771 1013</span></span>
<span><span class="co">#&gt; 3 site_a 0.38 1.2 1.5   -80   -60  -100 2021-03-01 0.12227893  2.059937865 1013</span></span>
<span><span class="co">#&gt; 4 site_a 0.38 1.2 1.5   -80   -60  -100 2021-04-01 0.14464345  4.725217894 1013</span></span>
<span><span class="co">#&gt; 5 site_a 0.38 1.2 1.5   -80   -60  -100 2021-05-01 0.11446588  8.825682240 1013</span></span>
<span><span class="co">#&gt; 6 site_a 0.38 1.2 1.5   -80   -60  -100 2021-06-01 0.09537391 10.377836383 1013</span></span>
<span><span class="co">#&gt;   gas      AFPS      DSD0           D0           DS    c_air</span></span>
<span><span class="co">#&gt; 1 CO2 0.2186472 0.1226866 1.373780e-05 1.685444e-06 44.73588</span></span>
<span><span class="co">#&gt; 2 CO2 0.2560726 0.1554984 1.381053e-05 2.147515e-06 44.60556</span></span>
<span><span class="co">#&gt; 3 CO2 0.2577211 0.1570023 1.399908e-05 2.197889e-06 44.27263</span></span>
<span><span class="co">#&gt; 4 CO2 0.2353565 0.1370158 1.424543e-05 1.951850e-06 43.84798</span></span>
<span><span class="co">#&gt; 5 CO2 0.2655341 0.1641957 1.462819e-05 2.401886e-06 43.21035</span></span>
<span><span class="co">#&gt; 6 CO2 0.2846261 0.1822189 1.477426e-05 2.692149e-06 42.97380</span></span></code></pre></div>
<p>Notice the <code>gas</code> column. This is essential because
different gases have specific diffusion coefficients. We can also remove
the <code>gas</code> column and provide a list of gases to
<code><a href="../reference/complete_soilphys.html">complete_soilphys()</a></code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">soilphys_measured_only</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">!</span><span class="va">gas</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/complete_soilphys.html">complete_soilphys</a></span><span class="op">(</span>DSD0_formula <span class="op">=</span> <span class="st">"a*AFPS^b"</span>, gases <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CO2"</span>, <span class="st">"CH4"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; The following columns were added: AFPS DSD0 D0 DS c_air</span></span>
<span><span class="co">#&gt; The following columns were overwritten:</span></span>
<span><span class="co">#&gt;     site  TPS   a   b depth upper lower       Date       SWC            t    p</span></span>
<span><span class="co">#&gt; 1 site_a 0.38 1.2 1.5   -80   -60  -100 2021-01-01 0.1613528 -0.789903514 1013</span></span>
<span><span class="co">#&gt; 2 site_a 0.38 1.2 1.5   -80   -60  -100 2021-01-01 0.1613528 -0.789903514 1013</span></span>
<span><span class="co">#&gt; 3 site_a 0.38 1.2 1.5   -80   -60  -100 2021-02-01 0.1239274  0.005814771 1013</span></span>
<span><span class="co">#&gt; 4 site_a 0.38 1.2 1.5   -80   -60  -100 2021-02-01 0.1239274  0.005814771 1013</span></span>
<span><span class="co">#&gt; 5 site_a 0.38 1.2 1.5   -80   -60  -100 2021-03-01 0.1222789  2.059937865 1013</span></span>
<span><span class="co">#&gt; 6 site_a 0.38 1.2 1.5   -80   -60  -100 2021-03-01 0.1222789  2.059937865 1013</span></span>
<span><span class="co">#&gt;        AFPS      DSD0 gas           D0           DS    c_air</span></span>
<span><span class="co">#&gt; 1 0.2186472 0.1226866 CO2 1.373780e-05 1.685444e-06 44.73588</span></span>
<span><span class="co">#&gt; 2 0.2186472 0.1226866 CH4 1.941795e-05 2.382322e-06 44.73588</span></span>
<span><span class="co">#&gt; 3 0.2560726 0.1554984 CO2 1.381053e-05 2.147515e-06 44.60556</span></span>
<span><span class="co">#&gt; 4 0.2560726 0.1554984 CH4 1.952075e-05 3.035445e-06 44.60556</span></span>
<span><span class="co">#&gt; 5 0.2577211 0.1570023 CO2 1.399908e-05 2.197889e-06 44.27263</span></span>
<span><span class="co">#&gt; 6 0.2577211 0.1570023 CH4 1.978726e-05 3.106646e-06 44.27263</span></span></code></pre></div>
<p>This replicates each row of the <code>data.frame</code> and
calculates distinct values for each gas.</p>
</div>
<div class="section level3">
<h3 id="from-measurements-to-layered-data-discretize_depth">From measurements to layered data:
<code>discretize_depth()</code><a class="anchor" aria-label="anchor" href="#from-measurements-to-layered-data-discretize_depth"></a>
</h3>
<p>As seen above, a <code>cfp_soilphys</code> object often requires the
combination of many different parameters. These parameters are typically
measured in very different ways and may be present in different data
formats. This presents a hurdle, as <code><a href="../reference/cfp_soilphys.html">cfp_soilphys()</a></code> requires
these datasets to all be present in the same layered format. The
function <code><a href="../reference/discretize_depth.html">discretize_depth()</a></code> helps with this by providing a
unified way to interpolate different observations to the same layered
structure. The basic idea is that you provide a vector of depths that
represent the layer boundaries. For
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
layers, you would need
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">n+1</annotation></semantics></math>
depths. Let’s say we measured a temperature profile at three depths: 0,
-30 and -100 cm:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temperature_profile</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>depth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="fl">30</span>, <span class="op">-</span><span class="fl">100</span><span class="op">)</span>,</span>
<span>             t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">20</span>, <span class="fl">16</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>If we want to map this to 10 cm-thick layers, we can simply define
the layer boundaries and use <code><a href="../reference/discretize_depth.html">discretize_depth()</a></code> to linearly
interpolate the observations:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">boundaries</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="fl">100</span>, by <span class="op">=</span> <span class="op">-</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/discretize_depth.html">discretize_depth</a></span><span class="op">(</span><span class="va">temperature_profile</span>,</span>
<span>                 param <span class="op">=</span> <span class="st">"t"</span>, </span>
<span>                 method <span class="op">=</span> <span class="st">"linear"</span>,</span>
<span>                 depth_target <span class="op">=</span> <span class="va">boundaries</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_layered_profile object </span></span>
<span><span class="co">#&gt; id_cols: </span></span>
<span><span class="co">#&gt; 1  unique profiles </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;           t depth upper lower</span></span>
<span><span class="co">#&gt; 1  16.28571   -95   -90  -100</span></span>
<span><span class="co">#&gt; 2  16.85714   -85   -80   -90</span></span>
<span><span class="co">#&gt; 3  17.42857   -75   -70   -80</span></span>
<span><span class="co">#&gt; 4  18.00000   -65   -60   -70</span></span>
<span><span class="co">#&gt; 5  18.57143   -55   -50   -60</span></span>
<span><span class="co">#&gt; 6  19.14286   -45   -40   -50</span></span>
<span><span class="co">#&gt; 7  19.71429   -35   -30   -40</span></span>
<span><span class="co">#&gt; 8  20.83333   -25   -20   -30</span></span>
<span><span class="co">#&gt; 9  22.50000   -15   -10   -20</span></span>
<span><span class="co">#&gt; 10 24.16667    -5     0   -10</span></span></code></pre></div>
<p>The function can handle profile data and treats every profile
distinctly. So if we adapt our example data to two profiles identified
by a <code>date</code> column, the interpolation works in the same way,
if we provide the necessary <code>id_cols</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">temperature_profile_dates</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>date_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"date_1"</span>, <span class="st">"date_2"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>,</span>
<span>             depth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="op">-</span><span class="fl">30</span>, <span class="op">-</span><span class="fl">100</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>             t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">20</span>, <span class="fl">16</span>, <span class="fl">15</span>, <span class="fl">10</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/cfp_profile.html">cfp_profile</a></span><span class="op">(</span>id_cols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"date_id"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/discretize_depth.html">discretize_depth</a></span><span class="op">(</span><span class="va">temperature_profile_dates</span>,</span>
<span>                 param <span class="op">=</span> <span class="st">"t"</span>, </span>
<span>                 method <span class="op">=</span> <span class="st">"linear"</span>,</span>
<span>                 depth_target <span class="op">=</span> <span class="va">boundaries</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_layered_profile object </span></span>
<span><span class="co">#&gt; id_cols: date_id </span></span>
<span><span class="co">#&gt; 2  unique profiles </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    date_id         t depth upper lower</span></span>
<span><span class="co">#&gt; 1   date_1 16.285714   -95   -90  -100</span></span>
<span><span class="co">#&gt; 2   date_1 16.857143   -85   -80   -90</span></span>
<span><span class="co">#&gt; 3   date_1 17.428571   -75   -70   -80</span></span>
<span><span class="co">#&gt; 4   date_1 18.000000   -65   -60   -70</span></span>
<span><span class="co">#&gt; 5   date_1 18.571429   -55   -50   -60</span></span>
<span><span class="co">#&gt; 6   date_1 19.142857   -45   -40   -50</span></span>
<span><span class="co">#&gt; 7   date_1 19.714286   -35   -30   -40</span></span>
<span><span class="co">#&gt; 8   date_1 20.833333   -25   -20   -30</span></span>
<span><span class="co">#&gt; 9   date_1 22.500000   -15   -10   -20</span></span>
<span><span class="co">#&gt; 10  date_1 24.166667    -5     0   -10</span></span>
<span><span class="co">#&gt; 11  date_2  8.142857   -95   -90  -100</span></span>
<span><span class="co">#&gt; 12  date_2  8.428571   -85   -80   -90</span></span>
<span><span class="co">#&gt; 13  date_2  8.714286   -75   -70   -80</span></span>
<span><span class="co">#&gt; 14  date_2  9.000000   -65   -60   -70</span></span>
<span><span class="co">#&gt; 15  date_2  9.285714   -55   -50   -60</span></span>
<span><span class="co">#&gt; 16  date_2  9.571429   -45   -40   -50</span></span>
<span><span class="co">#&gt; 17  date_2  9.857143   -35   -30   -40</span></span>
<span><span class="co">#&gt; 18  date_2 10.833333   -25   -20   -30</span></span>
<span><span class="co">#&gt; 19  date_2 12.500000   -15   -10   -20</span></span>
<span><span class="co">#&gt; 20  date_2 14.166667    -5     0   -10</span></span></code></pre></div>
<p>We can use different interpolation methods that may be more
applicable to other parameters. See the function documentation
<code><a href="../reference/discretize_depth.html">?discretize_depth</a></code> for details.</p>
</div>
</div>
<div class="section level2">
<h2 id="cfp_layers_map-create-the-model-layers">
<code>cfp_layers_map()</code>: Create the model layers<a class="anchor" aria-label="anchor" href="#cfp_layers_map-create-the-model-layers"></a>
</h2>
<p>The final aspect of a ConFluxPro model is the “layers_map”. This is a
layered <code>data.frame</code> that defines for which layers we want to
calculate flux rates. We provide a dataset that matches the other
example datasets:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"layers_map"</span>, package <span class="op">=</span> <span class="st">"ConFluxPro"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">layers_map</span></span>
<span><span class="co">#&gt;     site upper lower</span></span>
<span><span class="co">#&gt; 1 site_a     5     0</span></span>
<span><span class="co">#&gt; 2 site_b     7     0</span></span>
<span><span class="co">#&gt; 3 site_a     0  -100</span></span>
<span><span class="co">#&gt; 4 site_b     0  -100</span></span></code></pre></div>
<p>As you can see, we divide each of the site into two layers, one for
the organic layer with <code>depth &gt; 0</code> and one for the mineral
soil below. Notice, that the upper boundary is different between the
sites. This is because they have a different organic layer, that is also
reflected in the other datasets:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_gasdata</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">site</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>max_depth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">depth</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 2</span></span></span>
<span><span class="co">#&gt;   site   max_depth</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> site_a         5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> site_b         7</span></span>
<span></span>
<span><span class="va">my_soilphys</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">site</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>max_upper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">upper</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 2</span></span></span>
<span><span class="co">#&gt;   site   max_upper</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> site_a         5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> site_b         7</span></span></code></pre></div>
<p>Notice, that the extends of the layers_map should match your measured
data if you want to include it in the models. You cannot extend the
layers_map beyond your measurements.</p>
<p>How many layers to define in the <code><a href="../reference/cfp_layers_map.html">cfp_layers_map()</a></code> is up
to the user and depends on the research question and the resolution of
the recorded data. While it may be tempting to define a layer between
every observation depth in <code><a href="../reference/cfp_gasdata.html">cfp_gasdata()</a></code>, this may result
in artefacts in the modeled fluxes. Combining these layers may therefore
yield more robust results.</p>
<p>To create a valid <code>cfp_layers_map</code>, we still need to add
some information. These are only needed for a <code><a href="../reference/pro_flux.html">pro_flux()</a></code>
inverse model and are set to <code>NA</code> if missing.</p>
<ul>
<li>
<code>gas</code>: The gas as a <code><a href="https://rdrr.io/r/base/character.html" class="external-link">character()</a></code>.</li>
<li>
<code>lowlim</code>: The lower limit of production allowed in that
layer in µmol m<sup>-3</sup> s<sup>-1</sup>
</li>
<li>
<code>highlim</code>: The upper limit of production allowed in that
layer in µmol m<sup>-3</sup> s<sup>-1</sup>
</li>
<li>
<code>layer_couple</code>: Penalty factor, defaults to 0. See
<code>?cfp_layers_map()</code>
</li>
</ul>
<p>We can either do so in the function call or provide distinct values
ourselves. The <code>highlim</code> and <code>lowlim</code> values can
help to explicitly exclude unrealisitic processes in the optimization in
<code><a href="../reference/pro_flux.html">pro_flux()</a></code>. For example, we can set <code>lowlim</code> to
0, if we want to prevent consumption of CO<sub>2</sub>. Again, these
values are only relevant in the <code><a href="../reference/pro_flux.html">pro_flux()</a></code> model. In our
case, we want to add the limits for the gas <code>"CO2"</code>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_layers_map</span> <span class="op">&lt;-</span> </span>
<span>  <span class="fu"><a href="../reference/cfp_layers_map.html">cfp_layers_map</a></span><span class="op">(</span></span>
<span>    <span class="va">layers_map</span>,</span>
<span>    id_cols <span class="op">=</span> <span class="st">"site"</span>,</span>
<span>    gas <span class="op">=</span> <span class="st">"CO2"</span>,</span>
<span>    lowlim <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    highlim <span class="op">=</span> <span class="fl">1000</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; added 'gas' to id_cols</span></span>
<span></span>
<span><span class="va">my_layers_map</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_layers_map object </span></span>
<span><span class="co">#&gt; id_cols: site gas </span></span>
<span><span class="co">#&gt; 2  unique profiles </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     site upper lower gas lowlim highlim layer_couple layer pmap</span></span>
<span><span class="co">#&gt; 1 site_a     0  -100 CO2      0    1000            0     1    1</span></span>
<span><span class="co">#&gt; 2 site_b     0  -100 CO2      0    1000            0     1    1</span></span>
<span><span class="co">#&gt; 3 site_a     5     0 CO2      0    1000            0     2    2</span></span>
<span><span class="co">#&gt; 4 site_b     7     0 CO2      0    1000            0     2    2</span></span></code></pre></div>
<p>Note that we only added <code>"site"</code> as <code>id_cols</code>,
because we don’t need the model frame to change over time and therefore
use the same mapping for every <code>Date</code>. You can always use a
subset of the <code>id_cols</code> in <code><a href="../reference/cfp_soilphys.html">cfp_soilphys()</a></code> in
your <code><a href="../reference/cfp_layers_map.html">cfp_layers_map()</a></code>. At the minimum, you need to provide
<code>gas</code> within your <code>id_cols</code>.</p>
<p>With this complete, we now have everything to create a unified
dataset for a ConFluxPro model.</p>
</div>
<div class="section level2">
<h2 id="cfp_dat-combining-the-datasets">
<code>cfp_dat()</code>: Combining the datasets<a class="anchor" aria-label="anchor" href="#cfp_dat-combining-the-datasets"></a>
</h2>
<p>As a last step, we combine the three datasets into one unified frame
with <code><a href="../reference/cfp_dat.html">cfp_dat()</a></code>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cfp_dat.html">cfp_dat</a></span><span class="op">(</span><span class="va">my_gasdata</span>, <span class="va">my_soilphys</span>, <span class="va">my_layers_map</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; validating datasets</span></span>
<span><span class="co">#&gt; id_cols: site, Date, gas</span></span>
<span><span class="co">#&gt; 24 unique profiles</span></span>
<span></span>
<span><span class="va">my_dat</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_dat object to be used as input in ConFluxPro models. </span></span>
<span><span class="co">#&gt; id_cols: site Date gas </span></span>
<span><span class="co">#&gt; number of profiles:  24 </span></span>
<span><span class="co">#&gt; number of groups:  2</span></span></code></pre></div>
<p>This function does multiple things. (I) It ensures that the upper and
lower boundaries between the datasets match. The highest
<code>upper</code> of <code>soilphys</code> and <code>gasdata</code>
should match the highest <code>depth</code> in <code>gasdata</code>,
with the <code>lower</code> boundary correspondingly. (II) It matches
each profile to another and makes a list of all profiles and the
corresponding datasets. ConFluxPro does not require the
<code>id_cols</code> between the different datasets to match exactly, as
long as the different profiles can be mapped to another. This makes it
possible, for example, to map the same <code>soilphys</code> profiles to
multiple distinct <code>gasdata</code> profiles, without having to
replicate the <code>soilphys</code> dataset manually. We already make
use of this by providing only one <code>layers_map</code> per
<code>site</code> in our example that is not replicated for the
different <code>Date</code> of the the other datasets. (III) For each
profile, it separates the layers of <code>soilphys</code>, at each depth
where there is an observation in <code>gasdata</code>. This does not
change the calculation but is needed internally for the
<code><a href="../reference/pro_flux.html">pro_flux()</a></code> model. (IV) It adds the column <code>pmap</code>
to the <code>soilphys</code> dataset that indicates which layer, as
defined in <code><a href="../reference/cfp_layers_map.html">cfp_layers_map()</a></code> corresponds to that layer in
<code>soilphys</code>.</p>
<p>At its core, a <code>cfp_dat</code> object is simply a list. We can
access the different elements, including the generated
<code>profiles</code> <code>data.frame</code> like any element in a list
with the <code>$</code> operator.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_dat</span><span class="op">$</span><span class="va">profiles</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; A cfp_profile object </span></span>
<span><span class="co">#&gt; id_cols: prof_id </span></span>
<span><span class="co">#&gt; 6  unique profiles </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     site       Date gas gd_id sp_id group_id prof_id</span></span>
<span><span class="co">#&gt; 1 site_a 2021-01-01 CO2     1     1        1       1</span></span>
<span><span class="co">#&gt; 2 site_b 2021-01-01 CO2    13    13        2       2</span></span>
<span><span class="co">#&gt; 3 site_a 2021-02-01 CO2     2     2        1       3</span></span>
<span><span class="co">#&gt; 4 site_b 2021-02-01 CO2    14    14        2       4</span></span>
<span><span class="co">#&gt; 5 site_a 2021-03-01 CO2     3     3        1       5</span></span>
<span><span class="co">#&gt; 6 site_b 2021-03-01 CO2    15    15        2       6</span></span></code></pre></div>
<p>Within this <code>data.frame</code> we have identifiers for each
profile of the different datasets (<code>gd_id</code>,
<code>sp_id</code>, <code>group_id</code>) and an identifier of each
profile of the combined dataset <code>prof_id</code>.</p>
<p>We now are ready model.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Valentin Gartiser.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
